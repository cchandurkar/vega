<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Vega Demos</title>
    <script type="text/javascript" charset="utf-8" src="http://d3js.org/d3.v3.min.js" ></script>
    <script type="text/javascript" charset="utf-8" src="http://vega.github.io/vega/vega.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="http://cchandurkar.github.io/trails/trails.min.js"></script>
    <link rel="stylesheet" href="http://cchandurkar.github.io/trails/trails.css" media="screen" charset="utf-8">
  </head>
  <body>
    <div id="chart"></div>
    <div id="controls"></div>
    <script type="text/javascript">

    function parse(spec) {

      vg.parse.spec(spec, function(chart) {

        // Create Chart
        var matrixChart = chart({el:"#chart"}).update();

        // Create trail
        var trail = trails.create()
          .attr('viz', 'matrix-reorder')
          .attr('exampleId', '34')
          .addControls()
          .renderTo("#controls");

        // Listen to load events
        trail.listen('onSnapshotChanged', function(signalData){

          // This data has information about every lable that was swapped
          // while dragging the `src`
          signalData.forEach(function(data){


            console.log("srcOrder", data.src.order);
            console.log("destOrder", data.dest.order);

            // Swap order since signal changed it when triggered
            var tempOrder = data.src.order;
            data.src.order = data.dest.order;
            data.dest.order = tempOrder;


            // Update Signals
            matrixChart
              .signal("src", data.src)
              .signal("dest", data.dest)
              .update();

            // Reset Signals
            matrixChart
              .signal("src", {})
              .signal("dest", {})
              .signal("destOrder", undefined)
              .signal("dragging", undefined)
              .update();

          });

        });

        // Hold labels swapped while dragging
        var signalData = [];

        // Whenever dest is changed
        matrixChart.onSignal("destOrder", function(signal, value){
          if(value){
            var src = (JSON.parse(JSON.stringify(matrixChart.signal("src"))));
            var dest = (JSON.parse(JSON.stringify(matrixChart.signal("dest"))));
            if(dest._id && src._id && dest._id != src._id){
              signalData.push({ src: src, dest: dest });
            }
          }
        });

        // Whenever src changes to `{}`; dragging finishes; capture
        matrixChart.onSignal("src", function(signal, value){
          if(!value._id && signalData.length){
            trail.captureWithImage(signalData, matrixChart.toImageURL());
            signalData = [];
          }
        });

      });

    }

    parse("./specs/reorderMatrix.json");

    </script>
  </body>
</html>
