<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Vega Demos</title>
    <script type="text/javascript" src="../d3.min.js"></script>
    <script type="text/javascript" src="../vega.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" src="http://cchandurkar.github.io/trails/trails.min.js"></script>
    <link rel="stylesheet" href="http://cchandurkar.github.io/trails/trails.css" media="screen" charset="utf-8">
  </head>
  <body>
    <div id="chart"></div>
    <div id="controls"></div>
    <script type="text/javascript">
    function parse(spec) {
      vg.parse.spec(spec, function(chart) {

        // Create Chart
        var matrixChart = chart({el:"#chart"}).update();

        // Create trail
        var trail = trails.create()
          .attr('viz', 'matrix-reorder')
          .attr('exampleId', '34')
          .addControls()
          .renderTo("#controls");

        // Listen to load events
        trail.listen('onSnapshotChanged', function(signalData){
          matrixChart.signal("fixOrder", signalData).update();
          matrixChart.signal("fixOrder", null).update();
        });

        // Every time src signal changed (mousedown or mouseup)
        // Check if it is mousedown and set src data
        var firstSrc = null;
        matrixChart.onSignal("src", function(signal, value){
          if(value._id){
            firstSrc = value;
          }else if(!value._id && firstSrc){
            console.log("src");

            // Parse all datum's id and order
            var data = {};
            matrixChart.data().nodes.forEach(function(datum){
              data[datum._id] = datum.order;
            });

            // Capture
            trail.captureWithImage(data, matrixChart.toImageURL());

            // Reset src
            firstSrc = null;

          }
        });


      });
    }
    parse("./specs/reorderMatrix.json");
    </script>
  </body>
</html>
