<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Vega Demos</title>
    <script type="text/javascript" src="../d3.min.js"></script>
    <script type="text/javascript" src="../vega.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" src="http://cchandurkar.github.io/trails/trails.min.js"></script>
    <link rel="stylesheet" href="http://cchandurkar.github.io/trails/trails.css" media="screen" charset="utf-8">
  </head>
  <body>
    <div id="chart"></div>
    <div id="controls"></div>
    <script type="text/javascript">
    function parse(spec) {
      vg.parse.spec(spec, function(chart) {

        // Create Chart
        var matrixChart = chart({el:"#chart"}).update();
        // Object.keys(matrixChart.signal()).forEach(function(signal){
        //   matrixChart.onSignal(signal, function(name, value){
        //     console.log(name, value);
        //   });
        // });

        // Create trail
        var trail = trails.create()
          .attr('viz', 'matrix-reorder')
          .attr('exampleId', '34')
          .addControls()
          .renderTo("#controls");

        // Listen to load events
        trail.listen('onSnapshotChanged', function(signalData){

          // Update Signals
          matrixChart
            .signal("src", signalData.src)
            .signal("dest", signalData.dest)
            .update();

          // Update src and dest to
          matrixChart
            .signal("src", {})
            .signal("dest", {})
            .signal("destOrder", undefined)
            .signal("dragging", undefined)
            .update();

        });


        // hold signal data
        var signalData = {
          src: null,
          dest: null
        };

        // Every time src signal changed (mousedown or mouseup)
        // Check if it is mousedown and set src data
        matrixChart.onSignal("src", function(signal, value){

          if(value._id){
            signalData.src = value;
          } else {
            if(signalData.src && signalData.dest && signalData.src._id && signalData.dest._id){

              // Cloned to avoid Hot-referencing
              var clonedSignalData = (JSON.parse(JSON.stringify(signalData)));

              // Swap `order` in src and dest since it is updated by signal internally
              // Swapping is done in `clonedSignalData` and not in `signalData` to avoid Hot-Referencing
              var temp = clonedSignalData.src.order;
              clonedSignalData.src.order = clonedSignalData.dest.order;
              clonedSignalData.dest.order = temp;

              // Capture
              trail.captureWithImage(clonedSignalData, matrixChart.toImageURL());

              // Reset Data
              signalData.src = null;
              signalData.dest = null;

            }
          }
        });

        // Every time dest signal changed (on hovering over labels)
        // Check if it is dragging some label (check src is set) if set keep updating dest
        matrixChart.onSignal("dest", function(signal, value){
          if(value._id && signalData.src._id && signalData.src._id != value._id){
            signalData.dest = value;
          }
        });


      });
    }
    parse("./specs/reorderMatrix.json");
    </script>
  </body>
</html>
